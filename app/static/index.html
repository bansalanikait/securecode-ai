<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>SecureCode AI</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">

</head>
<body>
  <header class="nav">
    <a class="brand" href="/static/index.html" aria-label="SecureCode AI Home">
      <span class="brand-mark">SC</span>
      <span>SecureCode AI</span>
    </a>
    <nav class="nav-links" aria-label="Primary">
      <a href="/static/index.html">Scan</a>
      <a href="/static/history.html">History</a>
      <a href="#coverage">Coverage</a>
      <a href="#how-it-works">How It Works</a>
    </nav>
    <button id="theme-toggle" class="theme-toggle" type="button">Theme</button>
  </header>

  <main class="container">
    <section class="card hero">
      <p class="eyebrow">Application Security Platform</p>
      <h1>Detect vulnerabilities before they hit production.</h1>
      <p class="hero-copy">
        Scan individual files or full GitHub repositories and get severity-aware findings,
        actionable fixes, and downloadable reports for your security workflow.
      </p>
      <div class="hero-metrics">
        <div class="metric">
          <span class="metric-value">OWASP</span>
          <span class="metric-label">Top 10 aligned checks</span>
        </div>
        <div class="metric">
          <span class="metric-value">AI</span>
          <span class="metric-label">Context-aware recommendations</span>
        </div>
        <div class="metric">
          <span class="metric-value">PDF</span>
          <span class="metric-label">Shareable compliance reports</span>
        </div>
      </div>
    </section>

    <section class="grid" id="scanner">
      <div class="card stack">
        <h2>Scan File</h2>
        <p class="section-copy">Upload a single source file for an immediate security review.</p>
        <input id="file" type="file" />
        <button id="upload">Scan File</button>
      </div>
      <div class="card stack">
        <h2>Scan GitHub Repository</h2>
        <p class="section-copy">Analyze an entire codebase and get a full vulnerability breakdown.</p>
        <input id="repo-url" type="url" placeholder="https://github.com/owner/repo" />
        <button id="scan-repo">Scan Repo</button>
      </div>
    </section>

    <section class="info-grid" id="coverage">
      <article class="card info-card">
        <h3>Security Coverage</h3>
        <ul class="check-list">
          <li>Injection and unsafe input handling</li>
          <li>Insecure deserialization patterns</li>
          <li>Hardcoded secrets and credentials</li>
          <li>Authentication and access-control risks</li>
        </ul>
      </article>
      <article class="card info-card">
        <h3>What You Get</h3>
        <ul class="check-list">
          <li>Issue severity and affected line details</li>
          <li>Recommended secure coding fixes</li>
          <li>Score and grade for quick triage</li>
          <li>History tracking for every scan report</li>
        </ul>
      </article>
    </section>

    <section class="card" id="how-it-works">
      <h3>How It Works</h3>
      <div class="steps">
        <div class="step"><span>1</span>Submit file or repository URL.</div>
        <div class="step"><span>2</span>Engine scans code and identifies risks.</div>
        <div class="step"><span>3</span>Review prioritized findings and fixes.</div>
        <div class="step"><span>4</span>Export PDF and share with your team.</div>
      </div>
    </section>

    <section class="card trust-panel">
      <h3>Built For Secure Development Teams</h3>
      <div class="badge-row">
        <span class="badge">Risk Scoring</span>
        <span class="badge">Audit Ready</span>
        <span class="badge">Report History</span>
        <span class="badge">Developer Friendly</span>
      </div>
    </section>

    <div id="result"></div>
  </main>

  <footer class="footer">
    <p>SecureCode AI | Shift-left security for modern engineering teams.</p>
  </footer>

  <script>
    const resultEl = document.getElementById("result");
    const themeToggle = document.getElementById("theme-toggle");
    const themeKey = "securecode-theme";

    function escapeHtml(value) {
      return String(value ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    async function parseResponse(res) {
      let payload = {};
      try {
        payload = await res.json();
      } catch (_) {
        payload = {};
      }
      if (!res.ok) {
        throw new Error(payload.detail || "Request failed");
      }
      return payload;
    }

    function renderIssue(issue) {
      const filePart = issue.file ? `<div class="meta"><b>File:</b> ${escapeHtml(issue.file)}</div>` : "";
      const linePart = issue.line ? `<div class="meta"><b>Line:</b> ${escapeHtml(issue.line)}</div>` : "";
      return `
        <div class="vuln">
          ${filePart}
          ${linePart}
          <div><b>${escapeHtml(issue.issue || "Unknown issue")}</b> (${escapeHtml(issue.severity || "Unknown")})</div>
          <div class="meta"><b>Fix:</b> ${escapeHtml(issue.recommended_fix || "No recommendation available")}</div>
        </div>
      `;
    }

    function renderResultCard(data, options = {}) {
      const vulnerabilities = Array.isArray(data.vulnerabilities) ? data.vulnerabilities : [];
      const totalFiles = data.total_files_scanned || options.totalFiles || 1;
      const totalVulns = data.total_vulnerabilities ?? vulnerabilities.length;

      let html = `
        <div class="card">
          <h3>${escapeHtml(options.title || "Scan Result")}</h3>
          ${data.repo_url ? `<div class="meta"><b>Repository:</b> ${escapeHtml(data.repo_url)}</div>` : ""}
          <div class="meta"><b>Security Score:</b> ${escapeHtml(data.security_score ?? "-")}</div>
          <div class="meta"><b>Grade:</b> ${escapeHtml(data.grade ?? "-")}</div>
          <div class="meta"><b>Total Files Scanned:</b> ${escapeHtml(totalFiles)}</div>
          <div class="meta"><b>Total Vulnerabilities:</b> ${escapeHtml(totalVulns)}</div>
      `;

      if (!vulnerabilities.length) {
        html += `<div class="vuln">No vulnerabilities found.</div>`;
      } else {
        html += vulnerabilities.map(renderIssue).join("");
      }

      if (data.report_id) {
        html += `
          <div class="actions">
            <a href="/static/history.html?open=${encodeURIComponent(data.report_id)}">View Report</a>
            <a href="/report/${encodeURIComponent(data.report_id)}/pdf" target="_blank" rel="noopener">Download PDF</a>
          </div>
        `;
      }

      html += `</div>`;
      resultEl.innerHTML = html;
    }

    async function scanFile() {
      const file = document.getElementById("file").files[0];
      if (!file) {
        alert("Choose a file");
        return;
      }

      resultEl.innerHTML = `<div class="card">Scanning file...</div>`;
      const fd = new FormData();
      fd.append("file", file, file.name);

      try {
        const res = await fetch("/scan", { method: "POST", body: fd });
        const data = await parseResponse(res);
        renderResultCard(data, { title: "File Scan Result", totalFiles: 1 });
      } catch (err) {
        resultEl.innerHTML = `<div class="card err">File scan failed: ${escapeHtml(err.message)}</div>`;
      }
    }

    async function scanRepo() {
      const repoUrl = document.getElementById("repo-url").value.trim();
      if (!repoUrl) {
        alert("Enter a GitHub repository URL");
        return;
      }

      resultEl.innerHTML = `<div class="card">Scanning repository...</div>`;
      try {
        const res = await fetch("/scan-repo", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ repo_url: repoUrl }),
        });
        const data = await parseResponse(res);
        renderResultCard(data, { title: "Repository Scan Result" });
      } catch (err) {
        resultEl.innerHTML = `<div class="card err">Repo scan failed: ${escapeHtml(err.message)}</div>`;
      }
    }

    document.getElementById("upload").addEventListener("click", scanFile);
    document.getElementById("scan-repo").addEventListener("click", scanRepo);
    document.getElementById("repo-url").addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        scanRepo();
      }
    });

    function applyTheme(theme) {
      document.documentElement.setAttribute("data-theme", theme);
      themeToggle.textContent = theme === "light" ? "Dark Mode" : "Light Mode";
    }

    const savedTheme = localStorage.getItem(themeKey);
    if (savedTheme === "dark" || savedTheme === "light") {
      applyTheme(savedTheme);
    } else {
      const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
      applyTheme(prefersLight ? "light" : "dark");
    }

    themeToggle.addEventListener("click", () => {
      const currentTheme = document.documentElement.getAttribute("data-theme");
      const nextTheme = currentTheme === "light" ? "dark" : "light";
      applyTheme(nextTheme);
      localStorage.setItem(themeKey, nextTheme);
    });
  </script>
</body>
</html>
